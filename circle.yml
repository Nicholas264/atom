machine:
  environment:
    XCODE_SCHEME: test
    XCODE_WORKSPACE: test
    XCODE_PROJECT: test

  xcode:
    version: 7.3

  post:
    - |- # this weird literal syntax allows a : on the next line
      curl --header 'Accept: application/vnd.github.v3.raw' --output /tmp/mac.p12 $ATOM_MAC_CODE_SIGNING_CERT_DOWNLOAD_URL
    - security unlock-keychain -p $ATOM_MAC_CODE_SIGNING_KEYCHAIN_PASSWORD $ATOM_MAC_CODE_SIGNING_KEYCHAIN
    - security import /tmp/mac.p12 -P $ATOM_MAC_CODE_SIGNING_CERT_PASSWORD -k $ATOM_MAC_CODE_SIGNING_KEYCHAIN -T /usr/bin/codesign
    - security find-identity -p codesigning

general:
  artifacts:
    - out/atom-mac.zip
    - out/atom-mac-symbols.zip

dependencies:
  pre:
    - curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.31.3/install.sh | bash
    - nvm install 4.4.7
    - nvm use 4.4.7
    - npm install -g npm

  override:
    - script/bootstrap
    - script/build --code-sign

  post:
    - cd out/Atom-darwin-x64 && zip -r ../atom-mac.zip ./Atom.app && cd -
    - cd out && zip -r ./atom-mac-symbols.zip ./symbols && cd -

  cache_directories:
    - cache
    - apm/node_modules
    - script/node_modules
    - node_modules

test:
  override:
    - script/test
