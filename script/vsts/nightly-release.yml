name: 1.29.0-nightly$(Rev:r)

phases:

- template: windows.yml
- template: macos.yml
- template: linux.yml

- phase: Release
  queue: Hosted  # Need this for Python 2.7

  dependsOn:
  - Windows
  - Linux
  - macOS

  steps:
  - task: NodeTool@0
    inputs:
      versionSpec: 8.11.3
    displayName: Install Node.js 8.11.3

  # This has to be done separately because VSTS inexplicably
  # exits the script block after `npm install` completes.
  - script: |
      cd script
      npm install
    displayName: npm install

  - task: DownloadBuildArtifacts@0
    displayName: Download Release Artifacts
    inputs:
      artifactName: Binaries

  - script: |
      $(Build.SourcesDirectory)\script\publish-release.cmd --assets-path "$(System.ArtifactsDirectory)/Binaries"
    env:
      GITHUB_TOKEN: $(GITHUB_TOKEN)
    displayName: Create Nightly Release
